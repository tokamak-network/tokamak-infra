---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kibana-scripts
  namespace: log-monitoring
  labels:
    app: kibana
data:
  init.sh: |-
    #!/bin/bash

    url="http://localhost:5601/api/status"
    search_string='"savedObjects":{"level":"available",'

    until curl -u "elastic:${ELASTIC_PASSWORD}" -sb -H "Accept: application/json" "$url" | grep -q "$search_string"; do
        sleep 1
    done

    dashbaord_response_code=$(curl -s -X POST "http://localhost:5601/api/saved_objects/_import?overwrite=true" \
      -u "elastic:${ELASTIC_PASSWORD}" \
      --header 'kbn-xsrf: true' \
      --form file=@scripts/dashboard.ndjson \
      -o /dev/null \
      -w '%{http_code}')

    if [ "$dashbaord_response_code" -eq 200 ]; then
        echo "success to import dashbaord!"
    else
        echo "failed to import dashbaord."
    fi

    config_response_code=$(curl -s -X PUT 'http://localhost:5601/api/saved_objects/config/8.8.0' \
      -u "elastic:${ELASTIC_PASSWORD}" \
      --header 'kbn-xsrf: true;' \
      --header 'Content-Type: application/json' \
      --data '{
          "attributes": {
              "discover:sampleSize": "5000"
          }
      }' \
      -o /dev/null \
      -w '%{http_code}')

    if [ "$config_response_code" -eq 200 ]; then
        echo "success to set discover:sampleSize!"
    else
        echo "failed to set discover:sampleSize."
    fi

  dashboard.ndjson: |-
    {"attributes":{"fieldAttrs":"{\"log\":{\"count\":1}}","fieldFormatMap":"{}","fields":"[]","name":"titan-log","runtimeFieldMap":"{}","sourceFilters":"[]","timeFieldName":"@timestamp","title":"titan-log","typeMeta":"{}"},"coreMigrationVersion":"8.8.0","created_at":"2023-06-21T11:07:23.291Z","id":"5909ed13-7ea3-4bcb-9534-701fa8983192","managed":false,"references":[],"type":"index-pattern","typeMigrationVersion":"8.0.0","updated_at":"2023-06-21T11:07:23.291Z","version":"WzYzNSwyOV0="}
    {"attributes":{"columns":[],"description":"","grid":{},"hideChart":false,"isTextBasedQuery":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"err or crit\",\"language\":\"kuery\"},\"filter\":[{\"meta\":{\"disabled\":false,\"negate\":false,\"alias\":null,\"key\":\"kubernetes.container_name\",\"field\":\"kubernetes.container_name\",\"value\":\"exists\",\"type\":\"exists\",\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"},\"query\":{\"exists\":{\"field\":\"kubernetes.container_name\"}},\"$state\":{\"store\":\"appState\"}}],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["@timestamp","desc"]],"timeRestore":false,"title":"log stream","usesAdHocDataView":false},"coreMigrationVersion":"8.8.0","created_at":"2023-06-21T11:07:23.291Z","id":"bff6a430-0f70-11ee-97d7-c90ba3396e72","managed":false,"references":[{"id":"5909ed13-7ea3-4bcb-9534-701fa8983192","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":"5909ed13-7ea3-4bcb-9534-701fa8983192","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"type":"search","typeMigrationVersion":"8.0.0","updated_at":"2023-06-21T11:07:23.291Z","version":"WzYzNiwyOV0="}
    {"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[]}"},"optionsJSON":"{\"useMargins\":true,\"syncColors\":false,\"syncCursor\":true,\"syncTooltips\":false,\"hidePanelTitles\":false}","panelsJSON":"[{\"version\":\"8.8.0\",\"type\":\"lens\",\"gridData\":{\"x\":0,\"y\":0,\"w\":48,\"h\":7,\"i\":\"5dc126c4-200c-4f26-8a98-4817a4aa5050\"},\"panelIndex\":\"5dc126c4-200c-4f26-8a98-4817a4aa5050\",\"embeddableConfig\":{\"attributes\":{\"title\":\"Logs Count by Containers (converted)\",\"description\":\"\",\"visualizationType\":\"lnsMetric\",\"type\":\"lens\",\"references\":[{\"type\":\"index-pattern\",\"id\":\"5909ed13-7ea3-4bcb-9534-701fa8983192\",\"name\":\"indexpattern-datasource-layer-b8e425ae-2784-4c2f-b2fd-87bde39717b9\"},{\"type\":\"index-pattern\",\"name\":\"bee00a2f-77ce-43cf-9bf0-7b22abc8ed09\",\"id\":\"5909ed13-7ea3-4bcb-9534-701fa8983192\"}],\"state\":{\"visualization\":{\"layerId\":\"b8e425ae-2784-4c2f-b2fd-87bde39717b9\",\"layerType\":\"data\",\"metricAccessor\":\"3a3dc688-64ed-4a28-a739-fdc9ee007238\",\"breakdownByAccessor\":\"389c8e9a-0c96-460a-8dea-d190a92fab48\",\"maxCols\":10},\"query\":{\"query\":\"err or crit\",\"language\":\"kuery\"},\"filters\":[{\"meta\":{\"disabled\":false,\"negate\":false,\"alias\":null,\"key\":\"kubernetes.container_name\",\"field\":\"kubernetes.container_name\",\"value\":\"exists\",\"type\":\"exists\",\"index\":\"bee00a2f-77ce-43cf-9bf0-7b22abc8ed09\"},\"query\":{\"exists\":{\"field\":\"kubernetes.container_name\"}},\"$state\":{\"store\":\"appState\"}}],\"datasourceStates\":{\"formBased\":{\"layers\":{\"b8e425ae-2784-4c2f-b2fd-87bde39717b9\":{\"columns\":{\"389c8e9a-0c96-460a-8dea-d190a92fab48\":{\"label\":\"kubernetes.container_name.keyword: Descending\",\"dataType\":\"string\",\"operationType\":\"terms\",\"scale\":\"ordinal\",\"sourceField\":\"kubernetes.container_name.keyword\",\"isBucketed\":true,\"params\":{\"size\":10,\"orderBy\":{\"type\":\"column\",\"columnId\":\"3a3dc688-64ed-4a28-a739-fdc9ee007238\"},\"orderDirection\":\"desc\",\"otherBucket\":false,\"missingBucket\":false,\"parentFormat\":{\"id\":\"terms\"},\"include\":[],\"exclude\":[],\"includeIsRegex\":false,\"excludeIsRegex\":false},\"customLabel\":true},\"3a3dc688-64ed-4a28-a739-fdc9ee007238\":{\"label\":\"Count\",\"dataType\":\"number\",\"operationType\":\"count\",\"isBucketed\":false,\"scale\":\"ratio\",\"sourceField\":\"___records___\",\"params\":{\"emptyAsNull\":true},\"customLabel\":true}},\"columnOrder\":[\"389c8e9a-0c96-460a-8dea-d190a92fab48\",\"3a3dc688-64ed-4a28-a739-fdc9ee007238\"],\"incompleteColumns\":{}}}},\"textBased\":{\"layers\":{}}},\"internalReferences\":[],\"adHocDataViews\":{}}},\"hidePanelTitles\":false,\"enhancements\":{}},\"title\":\"Logs Count by Containers\"},{\"version\":\"8.8.0\",\"type\":\"search\",\"gridData\":{\"x\":0,\"y\":7,\"w\":48,\"h\":18,\"i\":\"33b19188-f31d-4138-aa8e-929b9d1663a4\"},\"panelIndex\":\"33b19188-f31d-4138-aa8e-929b9d1663a4\",\"embeddableConfig\":{\"enhancements\":{},\"hidePanelTitles\":false},\"title\":\"Logs\",\"panelRefName\":\"panel_33b19188-f31d-4138-aa8e-929b9d1663a4\"}]","timeRestore":false,"title":"Log","version":1},"coreMigrationVersion":"8.8.0","created_at":"2023-06-21T11:45:30.396Z","id":"488c0555-757a-4595-86da-2c8a33e80fe4","managed":false,"references":[{"id":"5909ed13-7ea3-4bcb-9534-701fa8983192","name":"5dc126c4-200c-4f26-8a98-4817a4aa5050:indexpattern-datasource-layer-b8e425ae-2784-4c2f-b2fd-87bde39717b9","type":"index-pattern"},{"id":"5909ed13-7ea3-4bcb-9534-701fa8983192","name":"5dc126c4-200c-4f26-8a98-4817a4aa5050:bee00a2f-77ce-43cf-9bf0-7b22abc8ed09","type":"index-pattern"},{"id":"bff6a430-0f70-11ee-97d7-c90ba3396e72","name":"33b19188-f31d-4138-aa8e-929b9d1663a4:panel_33b19188-f31d-4138-aa8e-929b9d1663a4","type":"search"}],"type":"dashboard","typeMigrationVersion":"8.7.0","updated_at":"2023-06-21T11:45:30.396Z","version":"WzY0OSwyOV0="}
    {"excludedObjects":[],"excludedObjectsCount":0,"exportedCount":3,"missingRefCount":0,"missingReferences":[]}
