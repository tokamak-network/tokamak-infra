---
# Source: elasticsearch/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: elasticsearch-config
  namespace: log-monitoring
  labels:
    app: "elasticsearch"
data:
  elasticsearch.yml: |
    node.store.allow_mmap: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: elasticsearch-scripts
  namespace: log-monitoring
data:
  init_password.sh: |-
    #!/bin/bash
    until curl -u "elastic:${ELASTIC_PASSWORD}" -s -f -o /dev/null "http://127.0.0.1:9200/_cluster/health?wait_for_status=yellow&timeout=1s"
    do
      sleep 1
    done

    curl  --location --request POST 'http://127.0.0.1:9200/_security/role/log_bulk' \
          -u "elastic:${ELASTIC_PASSWORD}" \
          --header 'Content-Type: application/json' \
          --data '{"indices": [{"names": [ "*" ],"privileges": ["all"]}]}'

    bin/elasticsearch-users useradd log_bulk -p ${ELASTIC_PASSWORD} -r log_bulk

    printf 'y\n%s\n%s\n' "$ELASTIC_PASSWORD" "$ELASTIC_PASSWORD" | bin/elasticsearch-reset-password -u kibana_system -i

    curl  --location --request PUT 'http://127.0.0.1:9200/_settings' \
          -u "elastic:${ELASTIC_PASSWORD}" \
          --header 'Content-Type: application/json' \
          --data '{"index": {"number_of_replicas": 0}}'
    